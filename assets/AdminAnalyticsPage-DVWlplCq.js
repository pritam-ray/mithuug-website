import{q as Q,v as H,r as d,s as h,j as e,g as P}from"./index-DDPWc_ZQ.js";import{D as J}from"./download-M3bti4Cr.js";import{D as $}from"./dollar-sign-BBIcdTZI.js";import{U as K}from"./users-DyaOR2bC.js";import{T as X}from"./trending-up-DN8dAK3T.js";import{C as Y}from"./calendar-C5LQugoM.js";import{S as Z}from"./star-B8AD6aH5.js";import{P as ee}from"./package-BRHkGikc.js";const de=()=>{const w=Q(),{isAdmin:y,isLoading:p}=H(),[s,E]=d.useState({totalRevenue:0,totalOrders:0,totalCustomers:0,averageOrderValue:0,revenueGrowth:0,ordersGrowth:0,topProducts:[],revenueByDay:[]}),[A,D]=d.useState(!0),[m,F]=d.useState("30days"),[S,C]=d.useState(!1);d.useEffect(()=>{!p&&!y&&w("/")},[y,p,w]),d.useEffect(()=>{z()},[m]);const z=async()=>{try{D(!0);const t=new Date;let o=new Date;switch(m){case"7days":o.setDate(t.getDate()-7);break;case"30days":o.setDate(t.getDate()-30);break;case"90days":o.setDate(t.getDate()-90);break;default:o=new Date(2020,0,1)}const{data:r,error:c}=await h.from("orders").select("*").eq("payment_status","paid").gte("created_at",o.toISOString());if(c)throw c;const{data:n,error:_}=await h.from("order_items").select("product_id, product_name, quantity, price");if(_)throw _;const g=(r==null?void 0:r.reduce((a,l)=>a+l.total_amount,0))||0,u=(r==null?void 0:r.length)||0,q=new Set((r==null?void 0:r.map(a=>a.user_id))||[]).size,U=u>0?g/u:0,O=new Date(o),V=t.getTime()-o.getTime();O.setTime(o.getTime()-V);const{data:i}=await h.from("orders").select("total_amount").eq("payment_status","paid").gte("created_at",O.toISOString()).lt("created_at",o.toISOString()),j=(i==null?void 0:i.reduce((a,l)=>a+l.total_amount,0))||0,v=(i==null?void 0:i.length)||0,B=j>0?(g-j)/j*100:0,I=v>0?(u-v)/v*100:0,f=new Map;n==null||n.forEach(a=>{const l=f.get(a.product_id)||{name:a.product_name,sales:0,revenue:0};l.sales+=a.quantity,l.revenue+=a.price*a.quantity,f.set(a.product_id,l)});const M=Array.from(f.entries()).map(([a,l])=>({id:a,...l})).sort((a,l)=>l.revenue-a.revenue).slice(0,5),T=[],b=new Date;b.setDate(t.getDate()-30);for(let a=0;a<30;a++){const l=new Date(b);l.setDate(b.getDate()+a);const L=l.toISOString().split("T")[0],G=(r==null?void 0:r.filter(N=>N.created_at.startsWith(L)))||[];T.push({date:L,revenue:G.reduce((N,W)=>N+W.total_amount,0),orders:G.length})}E({totalRevenue:g,totalOrders:u,totalCustomers:q,averageOrderValue:U,revenueGrowth:B,ordersGrowth:I,topProducts:M,revenueByDay:T})}catch(t){console.error("Error loading analytics:",t),alert("Failed to load analytics")}finally{D(!1)}},k=async()=>{try{C(!0);const t=[["MitthuuG Analytics Report"],[`Generated: ${new Date().toLocaleDateString()}`],[`Period: ${m}`],[],["Metric","Value"],["Total Revenue",`₹${s.totalRevenue.toFixed(2)}`],["Total Orders",s.totalOrders.toString()],["Total Customers",s.totalCustomers.toString()],["Average Order Value",`₹${s.averageOrderValue.toFixed(2)}`],["Revenue Growth",`${s.revenueGrowth.toFixed(2)}%`],["Orders Growth",`${s.ordersGrowth.toFixed(2)}%`],[],["Top Products"],["Product","Sales","Revenue"],...s.topProducts.map(n=>[n.name,n.sales.toString(),`₹${n.revenue.toFixed(2)}`])].map(n=>n.join(",")).join(`
`),o=new Blob([t],{type:"text/csv"}),r=window.URL.createObjectURL(o),c=document.createElement("a");c.href=r,c.download=`analytics-report-${new Date().toISOString().split("T")[0]}.csv`,c.click(),window.URL.revokeObjectURL(r),await h.rpc("log_admin_activity",{p_action:"export_analytics_report",p_details:{timeRange:m}})}catch(t){console.error("Error exporting report:",t),alert("Failed to export report")}finally{C(!1)}},x=t=>`₹${t.toFixed(2)}`,R=t=>`${t>=0?"+":""}${t.toFixed(1)}%`;return p||A?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-ochre"})}):e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsxs("div",{className:"flex justify-between items-center mb-8",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-chocolate-900 mb-2",children:"Analytics & Reports"}),e.jsx("p",{className:"text-chocolate-600",children:"Track your store performance and sales trends"})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("select",{value:m,onChange:t=>F(t.target.value),className:"px-4 py-2 border border-chocolate-300 rounded-lg focus:ring-2 focus:ring-ochre focus:border-transparent",children:[e.jsx("option",{value:"7days",children:"Last 7 Days"}),e.jsx("option",{value:"30days",children:"Last 30 Days"}),e.jsx("option",{value:"90days",children:"Last 90 Days"}),e.jsx("option",{value:"all",children:"All Time"})]}),e.jsxs("button",{onClick:k,disabled:S,className:"flex items-center gap-2 bg-ochre text-white px-6 py-2 rounded-lg hover:bg-ochre-600 transition-colors disabled:opacity-50",children:[e.jsx(J,{size:20}),S?"Exporting...":"Export Report"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-md p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("div",{className:"p-3 bg-green-100 rounded-lg",children:e.jsx($,{className:"text-green-600",size:24})}),e.jsx("span",{className:`text-sm font-semibold ${s.revenueGrowth>=0?"text-green-600":"text-red-600"}`,children:R(s.revenueGrowth)})]}),e.jsx("h3",{className:"text-chocolate-600 text-sm font-medium",children:"Total Revenue"}),e.jsx("p",{className:"text-3xl font-bold text-chocolate-900 mt-2",children:x(s.totalRevenue)})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-md p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("div",{className:"p-3 bg-blue-100 rounded-lg",children:e.jsx(P,{className:"text-blue-600",size:24})}),e.jsx("span",{className:`text-sm font-semibold ${s.ordersGrowth>=0?"text-green-600":"text-red-600"}`,children:R(s.ordersGrowth)})]}),e.jsx("h3",{className:"text-chocolate-600 text-sm font-medium",children:"Total Orders"}),e.jsx("p",{className:"text-3xl font-bold text-chocolate-900 mt-2",children:s.totalOrders})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-md p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsx("div",{className:"p-3 bg-purple-100 rounded-lg",children:e.jsx(K,{className:"text-purple-600",size:24})})}),e.jsx("h3",{className:"text-chocolate-600 text-sm font-medium",children:"Total Customers"}),e.jsx("p",{className:"text-3xl font-bold text-chocolate-900 mt-2",children:s.totalCustomers})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-md p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsx("div",{className:"p-3 bg-orange-100 rounded-lg",children:e.jsx(X,{className:"text-orange-600",size:24})})}),e.jsx("h3",{className:"text-chocolate-600 text-sm font-medium",children:"Avg. Order Value"}),e.jsx("p",{className:"text-3xl font-bold text-chocolate-900 mt-2",children:x(s.averageOrderValue)})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-md p-6",children:[e.jsxs("h2",{className:"text-xl font-bold text-chocolate-900 mb-4 flex items-center gap-2",children:[e.jsx(Y,{size:20}),"Revenue Trend (Last 30 Days)"]}),e.jsx("div",{className:"space-y-2",children:s.revenueByDay.slice(-10).map((t,o)=>{const r=Math.max(...s.revenueByDay.map(n=>n.revenue)),c=r>0?t.revenue/r*100:0;return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-chocolate-600 w-16",children:new Date(t.date).toLocaleDateString("en-US",{month:"short",day:"numeric"})}),e.jsx("div",{className:"flex-1 bg-chocolate-100 rounded-full h-8 relative",children:e.jsx("div",{className:"bg-ochre h-8 rounded-full flex items-center justify-end px-2",style:{width:`${c}%`},children:t.revenue>0&&e.jsxs("span",{className:"text-xs font-semibold text-white",children:["₹",t.revenue.toFixed(0)]})})}),e.jsxs("span",{className:"text-xs text-chocolate-600 w-12",children:[t.orders," orders"]})]},o)})})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-md p-6",children:[e.jsxs("h2",{className:"text-xl font-bold text-chocolate-900 mb-4 flex items-center gap-2",children:[e.jsx(Z,{size:20}),"Top Products"]}),e.jsx("div",{className:"space-y-4",children:s.topProducts.length===0?e.jsx("p",{className:"text-chocolate-500 text-center py-8",children:"No sales data available"}):s.topProducts.map((t,o)=>e.jsxs("div",{className:"flex items-center justify-between p-4 bg-chocolate-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-8 h-8 bg-ochre text-white rounded-full flex items-center justify-center font-bold",children:o+1}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-chocolate-900",children:t.name}),e.jsxs("p",{className:"text-sm text-chocolate-600",children:[t.sales," units sold"]})]})]}),e.jsx("div",{className:"text-right",children:e.jsx("p",{className:"font-bold text-chocolate-900",children:x(t.revenue)})})]},t.id))})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-md p-6",children:[e.jsx("h2",{className:"text-xl font-bold text-chocolate-900 mb-4",children:"Quick Insights"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"p-4 bg-blue-50 rounded-lg",children:[e.jsx(ee,{className:"text-blue-600 mb-2",size:24}),e.jsx("p",{className:"text-sm text-chocolate-600",children:"Conversion Rate"}),e.jsxs("p",{className:"text-2xl font-bold text-chocolate-900",children:[s.totalCustomers>0?(s.totalOrders/s.totalCustomers*100).toFixed(1):"0","%"]})]}),e.jsxs("div",{className:"p-4 bg-green-50 rounded-lg",children:[e.jsx(P,{className:"text-green-600 mb-2",size:24}),e.jsx("p",{className:"text-sm text-chocolate-600",children:"Orders per Customer"}),e.jsx("p",{className:"text-2xl font-bold text-chocolate-900",children:s.totalCustomers>0?(s.totalOrders/s.totalCustomers).toFixed(1):"0"})]}),e.jsxs("div",{className:"p-4 bg-purple-50 rounded-lg",children:[e.jsx($,{className:"text-purple-600 mb-2",size:24}),e.jsx("p",{className:"text-sm text-chocolate-600",children:"Customer Lifetime Value"}),e.jsx("p",{className:"text-2xl font-bold text-chocolate-900",children:x(s.totalCustomers>0?s.totalRevenue/s.totalCustomers:0)})]})]})]})]})};export{de as default};
