import{c as I,q as J,v as W,r as l,s as x,j as e,g as E,M as D,X,m as O}from"./index-DDPWc_ZQ.js";import{U as G}from"./users-DyaOR2bC.js";import{D as U}from"./dollar-sign-BBIcdTZI.js";import{S as K}from"./search-CAyVW2CM.js";import{C as Y}from"./calendar-C5LQugoM.js";import{E as Z}from"./eye-Dk-gwyaQ.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const M=I("UserCheck",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["polyline",{points:"16 11 18 13 22 9",key:"1pwet4"}]]),ce=()=>{const j=J(),{isAdmin:N,isSuperAdmin:b,isLoading:m}=W(),[o,R]=l.useState([]),[y,q]=l.useState([]),[T,w]=l.useState(!0),[i,F]=l.useState(""),[s,v]=l.useState(null),[$,h]=l.useState(!1),[V,_]=l.useState(!1),[C,S]=l.useState(!1);l.useEffect(()=>{!m&&!N&&j("/")},[N,m,j]),l.useEffect(()=>{k()},[]),l.useEffect(()=>{let t=[...o];i.trim()&&(t=t.filter(a=>{var r;return((r=a.full_name)==null?void 0:r.toLowerCase().includes(i.toLowerCase()))||a.email.toLowerCase().includes(i.toLowerCase())})),q(t)},[o,i]);const k=async()=>{try{w(!0);const{data:t,error:a}=await x.from("user_profiles").select("*").order("created_at",{ascending:!1});if(a)throw a;const r=await Promise.all((t||[]).map(async n=>{const{data:c}=await x.from("orders").select("id, total_amount, created_at").eq("user_id",n.id).eq("payment_status","paid"),H=(c==null?void 0:c.reduce((f,g)=>f+g.total_amount,0))||0,Q=(c==null?void 0:c.length)||0,p=c&&c.length>0?c.sort((f,g)=>new Date(g.created_at).getTime()-new Date(f.created_at).getTime())[0]:null;return{id:n.id,email:n.email,full_name:n.full_name||"Unknown",role:n.role||"customer",created_at:n.created_at,total_spent:H,order_count:Q,last_order_date:p==null?void 0:p.created_at}}));R(r)}catch(t){console.error("Error loading customers:",t),alert("Failed to load customers")}finally{w(!1)}},P=async t=>{try{_(!0);const{data:a,error:r}=await x.from("orders").select("id, order_number, total_amount, status, created_at").eq("user_id",t).order("created_at",{ascending:!1});if(r)throw r;s&&v({...s,orders:a||[]})}catch(a){console.error("Error loading customer orders:",a),alert("Failed to load customer orders")}finally{_(!1)}},z=async(t,a)=>{if(!b){alert("Only super admins can change user roles");return}if(confirm(`Are you sure you want to change this user's role to ${a}?`))try{S(!0);const{error:r}=await x.from("user_profiles").update({role:a}).eq("id",t);if(r)throw r;await x.rpc("log_admin_activity",{p_action:"change_user_role",p_details:{user_id:t,new_role:a}}),alert("User role updated successfully"),h(!1),k()}catch(r){console.error("Error updating user role:",r),alert("Failed to update user role")}finally{S(!1)}},u=t=>new Date(t).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}),d=t=>`â‚¹${t.toFixed(2)}`,A=t=>{switch(t){case"super_admin":return"bg-purple-100 text-purple-800";case"admin":return"bg-blue-100 text-blue-800";default:return"bg-gray-100 text-gray-800"}},L=t=>t==="super_admin"||t==="admin"?e.jsx(O,{size:14}):e.jsx(M,{size:14}),B=t=>{switch(t){case"delivered":return"bg-green-100 text-green-800";case"shipped":return"bg-purple-100 text-purple-800";case"confirmed":return"bg-blue-100 text-blue-800";case"pending":return"bg-yellow-100 text-yellow-800";case"cancelled":return"bg-red-100 text-red-800";case"refunded":return"bg-gray-100 text-gray-800";default:return"bg-gray-100 text-gray-800"}};return m||T?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-ochre"})}):e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsx("div",{className:"flex justify-between items-center mb-8",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-chocolate-900 mb-2",children:"Customers Management"}),e.jsx("p",{className:"text-chocolate-600",children:"View and manage customer accounts"})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6 mb-6",children:[e.jsx("div",{className:"bg-white rounded-lg shadow-md p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-chocolate-600 text-sm font-medium",children:"Total Customers"}),e.jsx("p",{className:"text-3xl font-bold text-chocolate-900 mt-2",children:o.length})]}),e.jsx(G,{className:"text-ochre",size:40})]})}),e.jsx("div",{className:"bg-white rounded-lg shadow-md p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-chocolate-600 text-sm font-medium",children:"Active Customers"}),e.jsx("p",{className:"text-3xl font-bold text-chocolate-900 mt-2",children:o.filter(t=>t.order_count>0).length})]}),e.jsx(E,{className:"text-ochre",size:40})]})}),e.jsx("div",{className:"bg-white rounded-lg shadow-md p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-chocolate-600 text-sm font-medium",children:"Total Revenue"}),e.jsx("p",{className:"text-3xl font-bold text-chocolate-900 mt-2",children:d(o.reduce((t,a)=>t+a.total_spent,0))})]}),e.jsx(U,{className:"text-ochre",size:40})]})}),e.jsx("div",{className:"bg-white rounded-lg shadow-md p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-chocolate-600 text-sm font-medium",children:"Avg. Order Value"}),e.jsx("p",{className:"text-3xl font-bold text-chocolate-900 mt-2",children:d(o.reduce((t,a)=>t+a.total_spent,0)/Math.max(1,o.reduce((t,a)=>t+a.order_count,0)))})]}),e.jsx(U,{className:"text-ochre",size:40})]})})]}),e.jsx("div",{className:"bg-white rounded-lg shadow-md p-6 mb-6",children:e.jsxs("div",{className:"relative",children:[e.jsx(K,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-chocolate-400",size:20}),e.jsx("input",{type:"text",placeholder:"Search by name or email...",value:i,onChange:t=>F(t.target.value),className:"w-full pl-10 pr-4 py-2 border border-chocolate-300 rounded-lg focus:ring-2 focus:ring-ochre focus:border-transparent"})]})}),e.jsx("div",{className:"bg-white rounded-lg shadow-md overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-chocolate-200",children:[e.jsx("thead",{className:"bg-chocolate-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-chocolate-700 uppercase tracking-wider",children:"Customer"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-chocolate-700 uppercase tracking-wider",children:"Role"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-chocolate-700 uppercase tracking-wider",children:"Joined"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-chocolate-700 uppercase tracking-wider",children:"Orders"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-chocolate-700 uppercase tracking-wider",children:"Total Spent"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-chocolate-700 uppercase tracking-wider",children:"Last Order"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-chocolate-700 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-chocolate-200",children:y.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"px-6 py-12 text-center text-chocolate-500",children:i?"No customers found matching your search":"No customers yet"})}):y.map(t=>e.jsxs("tr",{className:"hover:bg-chocolate-50 transition-colors",children:[e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-chocolate-900",children:t.full_name}),e.jsxs("div",{className:"text-sm text-chocolate-500 flex items-center gap-1",children:[e.jsx(D,{size:14}),t.email]})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("span",{className:`inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold ${A(t.role)}`,children:[L(t.role),t.role==="super_admin"?"Super Admin":t.role.charAt(0).toUpperCase()+t.role.slice(1)]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-chocolate-600",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Y,{size:14}),u(t.created_at)]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("span",{className:"inline-flex items-center gap-1 text-chocolate-900 font-medium",children:[e.jsx(E,{size:16}),t.order_count]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:"font-semibold text-chocolate-900",children:d(t.total_spent)})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-chocolate-600",children:t.last_order_date?u(t.last_order_date):"-"}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("button",{onClick:()=>{v(t),h(!0),P(t.id)},className:"inline-flex items-center gap-1 text-ochre hover:text-ochre-600 font-medium",children:[e.jsx(Z,{size:18}),"View Details"]})})]},t.id))})]})})}),$&&s&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto",children:[e.jsx("div",{className:"p-6 border-b border-chocolate-200",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-chocolate-900",children:s.full_name}),e.jsxs("p",{className:"text-chocolate-600 mt-1 flex items-center gap-2",children:[e.jsx(D,{size:16}),s.email]})]}),e.jsx("button",{onClick:()=>h(!1),className:"text-chocolate-400 hover:text-chocolate-600",children:e.jsx(X,{size:24})})]})}),e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"bg-chocolate-50 rounded-lg p-4",children:[e.jsx("p",{className:"text-chocolate-600 text-sm font-medium",children:"Total Orders"}),e.jsx("p",{className:"text-2xl font-bold text-chocolate-900 mt-1",children:s.order_count})]}),e.jsxs("div",{className:"bg-chocolate-50 rounded-lg p-4",children:[e.jsx("p",{className:"text-chocolate-600 text-sm font-medium",children:"Lifetime Value"}),e.jsx("p",{className:"text-2xl font-bold text-chocolate-900 mt-1",children:d(s.total_spent)})]}),e.jsxs("div",{className:"bg-chocolate-50 rounded-lg p-4",children:[e.jsx("p",{className:"text-chocolate-600 text-sm font-medium",children:"Average Order"}),e.jsx("p",{className:"text-2xl font-bold text-chocolate-900 mt-1",children:d(s.order_count>0?s.total_spent/s.order_count:0)})]})]}),b&&s.role!=="super_admin"&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("h3",{className:"font-semibold text-chocolate-900 mb-3",children:"Role Management"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("span",{className:"text-chocolate-600",children:"Current Role:"}),e.jsxs("span",{className:`inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold ${A(s.role)}`,children:[L(s.role),s.role==="admin"?"Admin":"Customer"]})]}),e.jsxs("div",{className:"mt-3 flex gap-2",children:[s.role!=="admin"&&e.jsxs("button",{onClick:()=>z(s.id,"admin"),disabled:C,className:"flex items-center gap-2 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 disabled:opacity-50",children:[e.jsx(O,{size:18}),"Promote to Admin"]}),s.role==="admin"&&e.jsxs("button",{onClick:()=>z(s.id,"customer"),disabled:C,className:"flex items-center gap-2 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 disabled:opacity-50",children:[e.jsx(M,{size:18}),"Demote to Customer"]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-chocolate-900 mb-3",children:"Order History"}),V?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-ochre"})}):s.orders&&s.orders.length>0?e.jsx("div",{className:"space-y-3",children:s.orders.map(t=>e.jsxs("div",{className:"bg-chocolate-50 rounded-lg p-4 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-chocolate-900",children:t.order_number}),e.jsx("p",{className:"text-sm text-chocolate-600",children:u(t.created_at)})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-semibold text-chocolate-900",children:d(t.total_amount)}),e.jsx("span",{className:`inline-flex px-2 py-1 rounded text-xs font-medium ${B(t.status)}`,children:t.status})]})]},t.id))}):e.jsx("p",{className:"text-chocolate-500 text-center py-8",children:"No orders yet"})]})]})]})})]})};export{ce as default};
