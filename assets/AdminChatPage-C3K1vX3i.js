import{h as $,N as z,r as i,s as o,j as e,x as T,p as v,Q as N,S as q}from"./index-DDPWc_ZQ.js";import{S as A}from"./SEO-BeZmPqYZ.js";function L(){const{user:a}=$(),{showToast:n}=z(),[u,w]=i.useState([]),[t,h]=i.useState(null),[p,f]=i.useState([]),[d,b]=i.useState(""),[E,y]=i.useState(!0),[c,S]=i.useState("all"),x=i.useRef(null),m=async()=>{try{y(!0);let s=o.from("chat_sessions").select(`
          *,
          user:auth.users!chat_sessions_user_id_fkey(email)
        `).order("last_message_at",{ascending:!1});c!=="all"&&(s=s.eq("status",c));const{data:r,error:l}=await s;if(l){console.error("Error loading sessions:",l);return}const g=(r||[]).map(j=>{var _;return{...j,user_email:((_=j.user)==null?void 0:_.email)||"Unknown"}});w(g)}catch(s){console.error("Error loading sessions:",s)}finally{y(!1)}},C=async s=>{try{const{data:r,error:l}=await o.from("chat_messages").select("*").eq("session_id",s).order("created_at",{ascending:!0});if(l){console.error("Error loading messages:",l);return}f(r||[])}catch(r){console.error("Error loading messages:",r)}},k=async s=>{if(a)try{const{error:r}=await o.rpc("assign_chat_admin",{p_session_id:s,p_admin_id:a.id});if(r){console.error("Error assigning admin:",r),n("Failed to assign chat","error");return}n("Chat assigned successfully","success"),m()}catch(r){console.error("Error assigning admin:",r),n("Failed to assign chat","error")}},M=async s=>{if(s.preventDefault(),!(!d.trim()||!t||!a))try{const{error:r}=await o.from("chat_messages").insert({session_id:t.id,sender_id:a.id,message:d,is_system_message:!1});if(r){console.error("Error sending message:",r),n("Failed to send message","error");return}b("")}catch(r){console.error("Error sending message:",r),n("Failed to send message","error")}},F=async s=>{try{const{error:r}=await o.rpc("close_chat_session",{p_session_id:s});if(r){console.error("Error closing session:",r),n("Failed to close chat","error");return}n("Chat closed successfully","success"),h(null),m()}catch(r){console.error("Error closing session:",r),n("Failed to close chat","error")}};return i.useEffect(()=>{if(!t)return;const s=o.channel(`admin_chat:${t.id}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_messages",filter:`session_id=eq.${t.id}`},r=>{const l=r.new;f(g=>[...g,l])}).subscribe();return()=>{s.unsubscribe()}},[t]),i.useEffect(()=>{const s=o.channel("admin_sessions").on("postgres_changes",{event:"*",schema:"public",table:"chat_sessions"},()=>{m()}).subscribe();return()=>{s.unsubscribe()}},[c]),i.useEffect(()=>{x.current&&x.current.scrollIntoView({behavior:"smooth"})},[p]),i.useEffect(()=>{m()},[c]),i.useEffect(()=>{t&&C(t.id)},[t]),e.jsxs(e.Fragment,{children:[e.jsx(A,{title:"Admin - Live Chat",description:"Manage customer support chats"}),e.jsx("div",{className:"min-h-screen bg-gray-50 py-8",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-4",children:[e.jsx("h1",{className:"text-3xl font-bold mb-8",children:"Live Chat Support"}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-1 bg-white rounded-lg shadow",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsx("div",{className:"flex",children:["all","waiting","active","closed"].map(s=>e.jsx("button",{onClick:()=>S(s),className:`flex-1 px-4 py-3 text-sm font-medium capitalize ${c===s?"border-b-2 border-black text-black":"text-gray-500 hover:text-gray-700"}`,children:s},s))})}),e.jsx("div",{className:"overflow-y-auto max-h-[calc(100vh-250px)]",children:E?e.jsx("div",{className:"flex items-center justify-center p-8",children:e.jsx(T,{className:"animate-spin text-gray-400",size:32})}):u.length===0?e.jsxs("div",{className:"text-center p-8 text-gray-500",children:[e.jsx(v,{size:48,className:"mx-auto mb-4 text-gray-300"}),e.jsxs("p",{children:["No ",c!=="all"?c:""," chats"]})]}):u.map(s=>e.jsxs("button",{onClick:()=>h(s),className:`w-full text-left p-4 border-b border-gray-200 hover:bg-gray-50 transition-colors ${(t==null?void 0:t.id)===s.id?"bg-gray-100":""}`,children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-sm",children:s.user_email}),e.jsx("p",{className:"text-xs text-gray-600 truncate",children:s.subject})]}),e.jsx("span",{className:`px-2 py-1 text-xs rounded-full ${s.status==="waiting"?"bg-yellow-100 text-yellow-800":s.status==="active"?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"}`,children:s.status})]}),e.jsx("p",{className:"text-xs text-gray-500",children:N(new Date(s.last_message_at),"MMM d, HH:mm")})]},s.id))})]}),e.jsx("div",{className:"lg:col-span-2 bg-white rounded-lg shadow flex flex-col",style:{height:"calc(100vh - 200px)"},children:t?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",children:t.user_email}),e.jsx("p",{className:"text-sm text-gray-600",children:t.subject})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[t.status==="waiting"&&t.admin_id!==(a==null?void 0:a.id)&&e.jsx("button",{onClick:()=>k(t.id),className:"px-3 py-1 bg-black text-white text-sm rounded-lg hover:bg-gray-800",children:"Assign to Me"}),t.status!=="closed"&&e.jsx("button",{onClick:()=>F(t.id),className:"px-3 py-1 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700",children:"Close Chat"})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:[p.map(s=>e.jsx("div",{className:`flex ${s.sender_id===(a==null?void 0:a.id)?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[75%] rounded-lg p-3 ${s.is_system_message?"bg-gray-100 text-gray-600 text-sm italic":s.sender_id===(a==null?void 0:a.id)?"bg-black text-white":"bg-gray-200 text-gray-800"}`,children:[e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s.message}),e.jsx("p",{className:"text-xs mt-1 opacity-70",children:N(new Date(s.created_at),"HH:mm")})]})},s.id)),e.jsx("div",{ref:x})]}),t.status!=="closed"&&e.jsx("div",{className:"p-4 border-t border-gray-200",children:e.jsxs("form",{onSubmit:M,className:"flex gap-2",children:[e.jsx("input",{type:"text",value:d,onChange:s=>b(s.target.value),placeholder:"Type your message...",className:"flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-black"}),e.jsxs("button",{type:"submit",disabled:!d.trim(),className:"bg-black text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2",children:[e.jsx(q,{size:20}),"Send"]})]})})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-gray-500",children:[e.jsx(v,{size:64,className:"mx-auto mb-4 text-gray-300"}),e.jsx("p",{children:"Select a chat to view messages"})]})})})]})]})})]})}export{L as default};
